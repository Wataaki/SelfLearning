# S3 (Amazon Simple Storage Service)  
非常に優れた耐久性を持つ、容量無制限のオブジェクトストレージサービス。  
ファイルストレージと違い、ディレクトリ構造を持たないフラットな構成であり、  
ユーザが独自にデータに対し情報 (メタデータ) を付与できる。  
S3 のオブジェクトには、 REST や SOAP などの Web API を使ってアクセスする。  
データを保存するため以外に EBS のスナップショットの保存場所として使われるなど  
AWS のバックエンドサービスにも使われる。

主なユースケースは  
- データバックアップ  
- ビックデータ解析用などのデータレイク  
- ETL の中間ファイル保存  
- Auto Scaling 構成された EC2 インスタンスやコンテナからのログ転送先  
- 静的コンテンツのホスティング  
- 簡易的な Key-Value 型のデータベース  

「大量・大容量」「長期間保存したい」「なくなると困る」といったデータを扱う場合に検討すると良い。  

## S3 の構成要素  

### バケット  
オブジェクトを保存するための領域。  
バケット名は AWS 内で一意にする必要がある。  

### オブジェクト  
S3 に格納されるデータそのもの。  
各オブジェクトにはキーが付与され「バケット名 + キー名 + バージョン ID」で必ず一意になる URL が作成される。  
この URL を Web API などで指定してオブジェクト操作する。  
格納できるオブジェクト数に制限はないが、 1 つのオブジェクトサイズは最大 5TB まで。  

### メタデータ  
オブジェクトを管理するための情報。  
オブジェクトの作成日時やサイズなどのシステム定義メタデータではなく、  
アプリケーションで必要な情報をユーザ定義メタデータとして保持することができる。  

## S3 の耐久性と整合性  
S3 に保存されたデータは、複数の AZ さらには AZ 内の複数の物理的ストレージに複製される。  
データの複製方式として、結果整合性方式を採用している。  
データの保存後、複製が完了するまでの間にデータを参照すると、参照先によっては保存前の状態が表示されることもある。  

### ストレージクラス  
5 つのランク分けがされている。  

#### STANDARD  
デフォルトのストレージクラス。  
S3 の性能が最も発揮されるクラス。  

#### STANDARD-IA  
**STANDARD** に比べて格納コストが安価なストレージタイプ。  
参照頻度が低いデータ向け。データへのアクセスは随時可能だが、データの読み出し容量に対する従量課金が行われる。  
高速なアクセスが必要なものの、それほど頻繁にはアクセスしないといったデータを保存する時に最適なクラス。  

#### ONEZONE-IA  
単一の AZ 内のみでデータを複製するストレージクラス。  
高い耐久性を発揮するが、 AZ 単位で障害が発生した場合にデータの復元ができない可能性がある。  
それ以外は **STANDARD-IA** と同等。

#### INTELLIGENT-TIERING  
参照頻度の高低を明確に決めることができないデータを扱う場合に有効なストレージタイプ。  
**STANDARD** と **STANDARD-IA** の 2 層構造となっており 30 日以上参照されなかったデータは自動的に **STANDARD-IA** に移動される。  
頻繁に移動が発生する場合はコスト高になることもある。  

#### GLACIER  
ほとんど参照されないアーカイブ目的のデータを保存するストレージタイプ。  
オブジェクト新規作成時にこのクラスを選択することはできない。  
**GLACIER** 以外のストレージクラスを選択して、ライフサイクル管理機能を使って利用可能となる。  
データにアクセスする場合は事前にアクセスをリクエストする必要があり、アクセスできるようになるまで数時間かかる。  

## ライフサイクル管理  
S3 に保存されたオブジェクトはその利用頻度に応じてライフサイクルを定義することができる。  
ライフサイクルには 2 種類ある。  

### 移行アクション  
データの利用頻度に応じてストレージクラスを変更するアクション。  
e.g.: オブジェクト作成当初はアクセス頻度が高いが、一定期間経過すると利用頻度や重要度が低くなり、最後はアーカイブとして保存しておく。 (STANDARD => STANDARD-IA => GLACIER)

### 有効期限アクション  
指定された期限を超えたオブジェクトを S3 から削除するアクション。  
利用期間が決まっているオブジェクトや一時的に作成されたオブジェクトなどを定期的に整理することができる。  

## バージョニング機能  
1 つのオブジェクトに対して複数のバージョン管理ができる。  
バージョニングはバケット単位で有効 / 無効を指定できる。  
差分管理ではなく、新旧オブジェクトの両方が保存される。  

## Web サイトホスティング機能  
静的なコンテンツに限って Web サイトとしてホスティングする環境を作成できる。  

### 独自ドメインで S3 Web サイトホスティングする場合の注意点  
S3 の Web サイトホスティングを設定すると自動的にドメイン (FQDN) が作成される。  
独自ドメインでアクセスしたい場合は Route 53 などの DNS に CNAME 情報を設定する。  
バケット名とドメイン名を一致させる必要がある。  
ただし CloudFront を配置する場合は一致させる必要はない。  

## S3 のアクセス管理 (バケットポリシー)  
バケット単位でアクセスを制御する。  
- ACL (アクセスコントロールリスト)  
  オブジェクト単位で公開 / 非公開を制御する場合に使用する。  
- IAM  
  ユーザ単位で S3 のリソースを制御する場合に利用する。  
  IAM ユーザの名称と一致したバケットのみを利用させるユースケースに適用可能。  

## 署名つき URL  
アクセスを許可したいオブジェクトに対して期限を指定して URL を発行する機能。  
バケットのアクセス管理することなく一時的にアクセス許可をしたい場合に有効。  
署名つき URL を知っていれば期間中は誰でもアクセスできる。  

## データの暗号化  
- サーバ側での暗号化  
  データがストレージに書き込まれる時に暗号化され、読み出される時に復号化される。  
- クライアント側での暗号化  
  AWS SDK を使って S3 に送信する前にデータが暗号化される。  
  複合時はクライアント側で暗号化したデータのメタデータに復号化するキーが含まれている。  

## CORS の設定  

## ストレージクラス  
- スタンダードと低頻度がある  
- 低頻度はアップロード料金が少し高め  

## 課金  
ファイルが存在する限り  
保存容量に応じて課金される。  
