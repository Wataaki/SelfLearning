# ELB (Elastic Load Balancing)
負荷分散、ロードバランサーのマネージドサービス。
3 タイプのロードバランサがある。

### Classic Load Balancer (CLB)
L4/L7 レイヤーでの負荷分散を行う。

### Application Load Balancer (ALB)
L7 レイヤーでの負荷分散を行う。
CLB より機能が豊富。

### Network Load Balancer (NLB)
L4 レイヤーでの負荷分散を行う。
HTTP, HTTPS 以外のプロトコル通信以外の負荷分散に使用する。

## ELB の特徴
負荷に応じて自動でスケールする設計になっている。
しかし、瞬時に行われるわけではないので急激に負荷がかかるシーン (スパイク) が予想される場合、
事前に ELB プレウォーミングの申請をする必要がある。

### ヘルスチェック
設定された間隔で配下にある EC2 にリクエストを送り、各インスタンスが正常に動作しているかを確認する。
異常なインスタンスは切り離し、正常になったら改めて紐づける。

#### ヘルスチェックの設定
- 対象のファイル
- ヘルスチェックの間隔
- 異常と判断するリクエスト連続失敗回数
- 正常に戻ったと判断するリクエスト成功回数

### オートスケーリング (Auto Scaling)
システムの利用状況に応じて自動的に ELB に紐づくインスタンスの台数を増減する。

#### オートスケーリングの設定
- 最小のインスタンス数
- 最大のインスタンス数
- インスタンスの数を増やす条件と増やす数 (CPU 使用率 など)
- インスタンスの数を減らす条件と減らす数
- 減らすインスタンスの優先度 (起動時間が最も過去の古いインスタンス など)

#### ELB と Auto Scalling を利用する際の設計ポイント
- サーバーをステートレスに設計する
    ファイルのアップロードなどしてインスタンス常に保持すると、
    リクエストが振り分けられると、ファイルが分散してしまう。
    また、オートスケーリングでアップロード先のインスタンスが削除されてしまう。
- AZ をまたがってインスタンスを配置する設計にする
    AZ 全体の障害が発生した場合に大変なことになる。
