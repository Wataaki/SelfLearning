# EFS (Elastic File System)
容量無制限で複数の EC2 インスタンスから同時にアクセス可能なファイルストレージサービス。  
EFS への接続は一般的な NFS クライアントがあれば良い。  
**amazon-efs-util** ツールを使うのが推奨される。  
パフォーマンスモードやスループットモードといったモードが用意されているので適切なモードを選択できるようにする。  

## EFS の構成要素
- ファイルシステム  
  EFS はファイルが作成されると自動的に 3 か所以上の AZ に保存される分散ファイルシステムを構成する。  
- マウントターゲット  
  AZ ごとにサブネットを指定してマウントターゲットを作成する。  
  マウントターゲットを作成すると、ターゲットポイント (FQDN) が 1 つと各 AZ のマウントターゲット用 IP アドレスが発行される。  
  EC2 からは FQDN でアクセスするが、内部的には自動的に接続元の EC2 インスタンスと同一 AZ のマウントターゲット IP アドレスが返却される。  
- セキュリティグループ  
  マウントターゲットにはセキュリティグループが設定できるので、 EC2 から EFS への通信要件を定義して、不要なアクセスを制限できる。  

## EFS のパフォーマンスモード
EFS には以下の 2 つのパフォーマンスモードがある。  
- 汎用パフォーマンスモード  
  ほとんどの場合は汎用パフォーマンスモードを使えば問題ない。  
- 最大 I/O パフォーマンスモード  
  数百 ~ 数千台のクライアントから同時にアクセスがあるようなユースケースにも耐えられるよう用意されている。  
  スループットが最大化する代わりに、各ファイル操作のレイテンシーが高まる。  

どちらのモードを選択するのが良いかを見分ける指標として CloudWatch の **PercentlOLimit** というメトリクスが参考になる。  
汎用パフォーマンスモードを選択し、システムのユースケースに似たアクセスパターンで性能テストを実施し、 PercentlOLimit がどのように遷移するかを確認する。  
PercentlOLimit が長時間高い状態 (80% ~ 100%) である場合は、「最大 I/O パフォーマンスモード」を選択すると良い場合がある。  
モードの変更はできないので、本番導入前に入念にテストすること。  

## EFS のスループットモード
EFS には以下の 2 つのスループットモードがある。  
- バーストスループットモード  
  EFS に保存されているデータ容量に応じてベースラインとなるスループットが設定されている。  
  一般的なスループットの上昇にも耐えられるようなバースト機能をもつモード。  
- プロビジョニングスループットモード  
  バーストスループットモードで設定されているベースラインを大幅に上回るスループットが必要な場合や、  
  一時的なバースト時にも高い性能が必要な場合に、任意のスループット値が設定できるモード。  
  それ以上のスループットが必要な場合は、緩和申請が必要。  
  Web 廃止に用のコンテンツやアプリケーション用のデータといった、データサイズはそれほど大きくはないものの  
  頻繁にアクセスしたり大量のインスタンスからの同時アクセスを受けるようなデータを EFS に配置する場合に最適。  

どちらのモードを選択するのが良いかを見分ける指標として CloudWatch の **BurstCreditBalance** というメトリクスが参考になる。  
クレジットバランスを全て使い切ってしまったり、常に減少傾向である場合はプロビジョニングスループットモードを選択すると良い。  
モードの変更は可能。作業には 24 時間以上の間隔を開ける必要がある。  
