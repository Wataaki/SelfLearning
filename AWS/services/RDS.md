# RDS (Amazon Relational Database Service)  
データベースのマネージドサービス  
RDB のデータベースエンジンを選択できる。  
Amazon Aurora という AWS が独自に開発したクラウドのメリットを最大限に活かした新しいアーキテクチャの RDS も提供されている。  
RDS では複数のデータベースエンジンを利用できるが、それぞれのエンジンで提供されている機能のうち、RDS では使用できない機能もある。  
アプリケーションの仕様上 RDS では使えない機能が必要な場合は EC2 インスタンスにデータベースエンジンをインストールして使うなどの検討が必要。  
DB インスタンスは EC2 と同じく、複数のインスタンスタイプから適正なスペックの物を選択できるが、  
データベースエンジンによっては選択できるインスタンスタイプが限定されていることもある。  

## RDS で使えるストレージタイプ
RDS のデータ保存用ストレージには EBS を利用する。  
EBS の中でも RDS で利用可能なストレージタイプは「汎用 SSD」「プロビジョンド IOPS SSD」「マグネティック」の 3 つ。  
新しい DB インスタンスを作成するときは SSD を選択する。  
ストレージの容量は 32TB まで拡張が可能。  

## RDS の特徴  

### マルチ AZ 構成
1 つのリージョン内の 2 つの AZ に DB インスタンスをそれぞれ配置し、障害発生時やメンテナンス時のダウンタイムを短くすることで高可用性を実現するサービス。  
DB インスタンス作成時にマルチ AZ 構成を選択するだけであとは全て AWS が自動で環境を作成してくれる。  
利用時に注意する点が 2 つある。  
- 書き込み速度が遅くなる  
  2 つの AZ 間でデータを同期するため、書き込みやコミットにかかる時間が長くなる。  
- フェイルオーバーには 60 ~ 120 秒かかる  

### リードレプリカ  
通常の RDS とは別に参照専用の DB インスタンスを作成することができるサービス。  
利用できるデータベースエンジンは、Aurora, MySql, MariaDB, PostgreSQL の 4 つ。  
リードレプリカを作成することで、マスター DB の負荷を抑えたり、読み込みが多いアプリケーションにおいて  
DB リソースのスケールアウトを容易に実現することが可能。  
例えばマスター DB のメンテナンス時でも参照系サービスだけは停止せず、アプリケーションの接続先をリードレプリカに変更することが可能。  
マスターとリードレプリカのデータ同期は非同期レプリケーション形式でおこなわれる。  

### バックアップ / リストア  

#### 自動バックアップ  
バックアップウィンドウと保持期間を指定することで 1 日に 1 回自動的にバックアップ (DB スナップショット) を取得してくれるサービス。  
バックアップの保持期間は最大 35 日。  
復旧する場合は取得したスナップショットを選択して新規 RDS を作成する。  
稼働中の RDS にバックアップのデータを戻すことはできない。  

#### 手動スナップショット  
任意のタイミングで RDB のバックアップ (DB スナップショット) を取得できるサービス。  
1 リージョンあたり 100 個までという制限がある。  

#### データのリストア  
RDS にデータをリストアする場合は、取得したスナップショットから新規の RDS を作成する。  

#### ポイントインタイムリカバリー  
直近 5 分から最大 35 日前までの任意のタイミングの状態の RDS を新規に作成することができるサービス。  
戻すことができる最大日数は自動バックアップの取得期間に準じる。  
なので、自動バックアップは有効にしておく必要がある。  

### セキュリティ  

#### ネットワークセキュリティ  
RDS は VPC に対応しているため、インターネットに接続できない AWS の VPC ネットワーク内で利用可能なサービス。  
DB インスタンス作成時のデフォルトはネットワーク接続 OFF となっている。  
EC2 や他 AWS サービスからの通信も、各データベースエンジンが提供する SSL を使った暗号化に対応している。  

#### データ暗号化  
暗号化オプションを有効化することでデータが保存されるストレージやスナップショットやログなどの RDS に関連する全てのデータが暗号化された状態で保存される。  
このオプションは途中から有効にすることができない。  
すでにあるデータに対して暗号化を実施したい場合はスナップショットを取得して、暗号化コピーを作成する。  
その暗号化スナップショットから DB インスタンスを作成することで既存データの暗号化がされる。  

## Amazon Aurora  

### Aurora の構成要素
DB インスタンスを作成すると同時に DB クラスタが作成される。  
DB クラスタは 1 つ以上の DB インスタンスと、各 DB インスタンスから参照するデータストレージで構成される。  
Aurora のデータストレージは SSD をベースとしたクラスタボリューム。  
クラスタボリュームは、単一リージョン内の 3 つの AZ にそれぞれ 2 つのデータコピーで構成され、各ストレージ間のデータは自動的同期される。  
最大 64TB まで自動的に拡張される。  

### Aurora レプリカ
Aurora にはマルチ AZ 構成オプションは無い。  
しかし、Aurora クラスタ内に参照専用のレプリカインスタンスを作成することができる。  
ほかの リードレプリカとの違いは、Aurora のプライマリインスタンスに障害が発生した場合にレプリカインスタンスがプライマリインスタンスに昇格することでフェイルオーバーを実現する点。  

### エンドポイント
RDS を作成すると接続用エンドポイント (FQDN) が 1 つ作成される。  

#### クラスタエンドポイント
プライマリインスタンスに接続するためのエンドポイント。  
データベースの全ての操作を受け付けることができる。

#### 読み取りエンドポイント
レプリカインスタンスに接続するためのエンドポイント。  
データベースの参照のみ受け付けることができる。  
複数のレプリカインスタンスが存在する場合は、自動で負荷分散がされる。  

#### インスタンスエンドポイント
各 DB インスタンスに接続するためのエンドポイント。  
特定の DB インスタンスに接続したい場合に使用する。  
